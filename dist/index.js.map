{"version":3,"file":"index.js","sources":["../src/lib/emiiter.ts","../src/utils.ts","../src/lib/index.ts"],"sourcesContent":["class Emiiter<T = any> {\n  private quenes: Map<any, Array<any>>;\n  constructor() {\n    this.quenes = new Map();\n  }\n  public on(eventName: string, fn: Function): this {\n    this.quenes.has(eventName) || this.quenes.set(eventName, []);\n    this.quenes.get(eventName)!.push(fn);\n    return this;\n  }\n  public addEventListener(eventName: string, fn: Function): this {\n    this.quenes.has(eventName) || this.quenes.set(eventName, []);\n    this.quenes.get(eventName)!.push(fn);\n    return this;\n  }\n  public off(eventName: string, fn: Function): this {\n    const quene: Array<any> = this.quenes.get(eventName) || [];\n    if (!quene) {\n      return this;\n    }\n    for (let i = 0; i < quene.length; i++) {\n      if (quene[i] === fn || quene[i].fn === fn) {\n        quene.splice(i, 1);\n      }\n    }\n    return this;\n  }\n  public once(eventName: string, fn: Function) {\n    const that = this;\n    const once = function(){\n      that.off(eventName, fn);\n      fn.call(that, arguments);\n    }\n    once.fn = fn;\n    this.on(eventName, once);\n    return this;\n  }\n  public emit(eventName: string, ...args: T[]) {\n    const quene: Array<Function> = this.quenes.get(eventName) || [];\n    if (quene) {\n      for (const callback of quene) {\n        callback.call(this, ...args);\n      }\n    }\n    return this;\n  }\n}\n\nexport default Emiiter;\n","export function log(type: \"success\" | \"error\" | \"warning\", msg: string) {\r\n  const colorList = {\r\n    success: \"color:#67C23A\",\r\n    error: \"color:#F56C6C\",\r\n    warning: \"color:#409EFF\",\r\n  };\r\n  console.log(\"%c \" + msg, colorList[type]);\r\n}\r\n","import Emiiter from './emiiter';\nimport { log } from '../utils';\n\nconst STATUS = {\n  CONNECTING: 0,\n  OPEN: 1,\n  CLOSING: 2,\n  CLOSED: 3,\n};\n\ninterface IOptions {\n  protocol?: string | Array<string>;\n  _reconnect?: boolean; // ÊòØÂê¶ÈáçÈÄ£\n  _autoConnect?: boolean; // ÊòØÂê¶Ëá™ÂãïÈèàÊé•\n  _reconnectionAttempts?: number; // ÈáçÈÄ£Ê¨°Êï∏\n  _reconnectionDelay?: number; // ÈáçÈÄ£ÊôÇÈñì\n}\n\nexport default class KWebsocket extends Emiiter {\n  public kwebsocket: WebSocket | undefined;\n  public url: string | URL;\n  public options: IOptions | undefined;\n  public protocol: string | Array<string>;\n  public reconnectionCount: number = 0;\n  public _autoConnect: boolean;\n  public _reconnect: boolean;\n  public _reconnectionAttempts: number;\n  public _reconnectionDelay: number;\n  public _status: number;\n  public _reconnectTimeoutId: number | undefined;\n  constructor(url: string | URL, options?: IOptions) {\n    super();\n    this.url = url;\n    this.protocol = options?.protocol || [];\n    this._autoConnect = options?._autoConnect || false;\n    this._reconnect = options?._reconnect || false;\n    this._reconnectionAttempts = options?._reconnectionAttempts || Infinity;\n    this._reconnectionDelay = options?._reconnectionDelay || 500;\n    this._status = STATUS.CLOSED;\n    this._autoConnect && this.doOpen();\n  }\n  public doOpen(url: string | URL = this.url): this {\n    try {\n      if (this._status === STATUS.CLOSED) {\n        this._status = STATUS.CONNECTING;\n        if (typeof window === 'object') {\n          // windowÂè™Â≠òÂú®‰∫éÊµèËßàÂô®Á´Ø\n          this.kwebsocket = new WebSocket(url, this.protocol);\n        } else if (\n          Object.prototype.toString.call(process) === '[object process]'\n        ) {\n          // Áî±Êñº jest ÊòØÂú® node Á´ØÈÅãË°åÔºåÊâÄ‰ª•ÈúÄË¶ÅÊ∑ªÂä† node Áí∞Â¢ÉÁöÑ websocket\n          const node_websocket = require('ws');\n          this.kwebsocket = new node_websocket(url, this.protocol);\n        }\n        this.addEventListeners();\n      }\n    } catch (error) {\n      log('error', JSON.stringify(error));\n    }\n    return this;\n  }\n  public doClose(): this {\n    this._status = STATUS.CLOSING;\n    this._reconnect = false;\n    (this.kwebsocket as WebSocket).close();\n    this.kwebsocket = undefined;\n    return this;\n  }\n  private reconnect(): this {\n    if (\n      this.reconnectionCount < this._reconnectionAttempts &&\n      this._status === STATUS.CLOSED\n    ) {\n      log('warning', 'üíï ÈáçÈÄ£‰∏≠');\n      this.reconnectionCount++;\n      window.clearInterval(this._reconnectTimeoutId);\n      this._reconnectTimeoutId = window.setTimeout(() => {\n        this.doOpen();\n      }, this._reconnectionDelay);\n    }\n    return this;\n  }\n  public send(msg: string): this {\n    if (this._status === STATUS.CLOSING || this._status === STATUS.CLOSED) {\n      return this;\n    }\n    if (this._status === STATUS.OPEN) {\n      (this.kwebsocket as WebSocket).send(msg);\n    }\n    return this;\n  }\n  private addEventListeners(): this {\n    ['onopen', 'onclose', 'onmessage', 'onerror'].forEach((res: string) => {\n      // @ts-ignore: Unreachable code error\n      this.kwebsocket[res] = (data: any) => {\n        if (res === 'onopen') {\n          super.emit(res);\n          this._status = STATUS.OPEN;\n          log('success', 'üôÇ ÈÄ£Êé•ÊàêÂäü');\n        }\n        if (res === 'onmessage') {\n          super.emit(res, data.data);\n          log('success', 'üòÑ ÊàêÂäüÊî∂Âà∞Ë®äÊÅØ,Ë®äÊÅØÁÇ∫ ' + data.data);\n        }\n        if (res === 'onclose') {\n          super.emit(res, data);\n          this._status = STATUS.CLOSED;\n          log('error', 'ÈÄ£Êé•Â∑≤ÈóúÈñâ');\n          this._reconnect && this.reconnect();\n        }\n        if (res === 'onerror') {\n          super.emit(res, data);\n          this._status = STATUS.CLOSING;\n          log('error', 'ÈÄ£Êé•Â§±Êïó,ÁôºÁîüÈåØË™§');\n        }\n      };\n    });\n    return this;\n  }\n}\n"],"names":[],"mappings":"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"}